# Ansible Rollid Kodut√∂√∂: PostgreSQL Andmebaasi Roll

\!\!\! info "√úldinfo"
**Eeldused:** Labor l√§bitud, Ansible rollide p√µhim√µtted selged  
**Ajakulu:** \~1.5 tundi  
**Esitamine:** GitHub repository URL + refleksioon  
**T√§htaeg:** 1 n√§dal p√§rast laborit

-----

## √úlesande Kirjeldus

Laboris l√µid Nginx veebiserveri rolli.  
N√º√ºd tuleb **rakendada samu p√µhim√µtteid uue tehnoloogiaga** ‚Äì PostgreSQL andmebaasiga.

**Miks PostgreSQL?**

  - Teine tehnoloogia (andmebaas, mitte veebiserver)
  - Sama loogika (install, configure, templates)
  - Reaalne olukord: iga rakendus vajab andmebaasi
  - Harjutad rollide m√µistet s√ºgavamalt

\!\!\! warning
PostgreSQL roll ei tohi olla lihtsalt koopia Nginx rollist\!  
Kasuta sarnast struktuuri, aga uue tehnoloogia jaoks sobivaid tasks‚Äôe ja template‚Äôe.

-----

## 1\. Rolli Struktuur (15 min)

### Loo roll

```bash
# Liigu oma rollide kausta
cd ~/ansible-roles-lab/roles

# Loo uus postgresql roll
ansible-galaxy init postgresql

# Liigu uude rolli kausta
cd postgresql
```

**Kontrolli, et struktuur on korrektne:**

  * `defaults/main.yml` ‚Äî muutujad, mida kasutaja saab muuta
  * `vars/main.yml` ‚Äî s√ºsteemispetsiifilised v√§√§rtused
  * `tasks/main.yml` ‚Äî rolli p√µhiloogika
  * `templates/` ‚Äî konfiguratsioonifailid (`postgresql.conf`, `pg_hba.conf`)
  * `handlers/main.yml` ‚Äî teenuse restart/reload
  * `meta/main.yml` ‚Äî s√µltuvused (vajadusel)

-----

## 2\. P√µhilised Tasks‚Äôid (20 min)

### Eesm√§rk

Luua Ansible roll, mis:

1.  Paigaldab PostgreSQL-i
2.  K√§ivitab ja lubab teenuse
3.  Loob andmebaasi ja kasutaja
4.  Rakendab konfiguratsiooni

-----

### 1\. PostgreSQL paigaldamine

```yaml
# tasks/main.yml
- name: Install PostgreSQL and dependencies
  apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2  # Vajalik Ansible postgres moodulitele
    state: present
    update_cache: yes
```

### 2\. Teenuse kontroll

```yaml
# tasks/main.yml
- name: Ensure PostgreSQL service is started and enabled
  service:
    name: "{{ postgres_service_name }}"
    state: started
    enabled: yes
```

### 3\. Andmebaasi loomine

```yaml
# tasks/main.yml
- name: Create application database
  community.postgresql.postgresql_db:
    name: "{{ postgres_db_name }}"
    state: present
  become: yes
  become_user: postgres
```

### 4\. Kasutaja loomine

```yaml
# tasks/main.yml
- name: Create database user
  community.postgresql.postgresql_user:
    name: "{{ postgres_user }}"
    password: "{{ postgres_password }}"
    db: "{{ postgres_db_name }}"
    priv: "ALL"
    state: present
  become: yes
  become_user: postgres
```

\!\!\! tip
PostgreSQL k√§sud peavad jooksma `postgres` kasutajana, mitte root‚Äôina. Selleks kasutame `become: yes` ja `become_user: postgres`.

-----

## 3\. Muutujad (10 min)

Roll peab kasutama h√§sti struktureeritud muutujaid:

  * **`defaults/main.yml`** ‚Äì vaikeseaded, mida kasutaja saab muuta
  * **`vars/main.yml`** ‚Äì s√ºsteemispetsiifilised v√§√§rtused, mida tavaliselt ei muudeta

-----

### defaults/main.yml

```yaml
---
# defaults/main.yml

postgres_version: 14
postgres_port: 5432
postgres_listen_addresses: 'localhost'

# Database and user settings
postgres_db_name: myapp_db
postgres_user: myapp_user
postgres_password: "changeme"  # Soovita muuta!

# Performance settings
postgres_max_connections: 100
postgres_shared_buffers: "128MB"
postgres_work_mem: "4MB"

# Logging settings
postgres_log_destination: 'stderr'
postgres_logging_collector: 'on'

# Remote access settings (for pg_hba.conf)
postgres_allow_remote: false
postgres_remote_subnet: '0.0.0.0/0'
```

-----

### vars/main.yml

```yaml
---
# vars/main.yml

_postgres_packages:
  Debian:
    - "postgresql-{{ postgres_version }}"
    - "postgresql-contrib-{{ postgres_version }}"
    - python3-psycopg2
  RedHat:
    - "postgresql{{ postgres_version }}-server"
    - "postgresql{{ postgres_version }}-contrib"
    - python3-psycopg2

postgres_config_dir: "/etc/postgresql/{{ postgres_version }}/main"
postgres_data_dir: "/var/lib/postgresql/{{ postgres_version }}/main"
postgres_service_name: "postgresql"
```

**Selgitus:**

  * `defaults` ‚Äì annab paindlikkuse (kasutaja saab muuta)
  * `vars` ‚Äì fikseeritud s√ºsteemiseaded

-----

## 4\. Template‚Äôid (25 min)

### 1\. PostgreSQL konfiguratsioon

Loo fail `templates/postgresql.conf.j2`:

```ini
# PostgreSQL Configuration (Generated by Ansible)

listen_addresses = '{{ postgres_listen_addresses }}'
port = {{ postgres_port }}
max_connections = {{ postgres_max_connections }}

shared_buffers = {{ postgres_shared_buffers }}
work_mem = {{ postgres_work_mem }}

logging_collector = {{ postgres_logging_collector }}
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_destination = '{{ postgres_log_destination }}'
```

-----

### 2\. Autentimise fail

Loo fail `templates/pg_hba.conf.j2`:

```jinja
# PostgreSQL Client Authentication (Generated by Ansible)
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     peer
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
# IPv6 local connections:
host    all             all             ::1/128                 md5

# Allow remote connections for the application user if enabled
{% if postgres_allow_remote %}
host    {{ postgres_db_name }}  {{ postgres_user }}  {{ postgres_remote_subnet }}  md5
{% endif %}
```

-----

### 3\. Lisa template‚Äôide rakendamine tasks‚Äôi l√µppu

```yaml
# tasks/main.yml
- name: Configure PostgreSQL settings
  template:
    src: postgresql.conf.j2
    dest: "{{ postgres_config_dir }}/postgresql.conf"
    owner: postgres
    group: postgres
    mode: '0644'
  notify: restart postgresql

- name: Configure client authentication
  template:
    src: pg_hba.conf.j2
    dest: "{{ postgres_config_dir }}/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: '0640'
  notify: restart postgresql
```

-----

## 5\. Handlers (10 min)

Loo `handlers/main.yml`:

```yaml
---
# handlers/main.yml
- name: restart postgresql
  service:
    name: "{{ postgres_service_name }}"
    state: restarted

- name: reload postgresql
  service:
    name: "{{ postgres_service_name }}"
    state: reloaded
```

\!\!\! question
Kas oled kasutanud `notify: restart postgresql` k√µikides tasks‚Äôides, mis muudavad konfiguratsiooni?

-----

## 6\. Test Playbook (5 min)

Loo fail `test-postgresql.yml` **projekti juurkausta** (mitte rolli sisse):

```yaml
---
# test-postgresql.yml
- name: Test PostgreSQL Role
  hosts: all
  become: yes
  roles:
    - role: postgresql
      vars:
        postgres_db_name: testapp_db
        postgres_user: testapp_user
        postgres_password: "SecurePass123"
        postgres_max_connections: 150
```

K√§ivita:

```bash
ansible-playbook -i inventory test-postgresql.yml
```

Kontrolli idempotentsust (k√§ivita teist korda):

```bash
ansible-playbook -i inventory test-postgresql.yml
# PEAB OLEMA: changed=0
```

-----

## 7\. Kontroll ja Testimine (15 min)

### Serveris

```bash
vagrant ssh
sudo systemctl status postgresql
sudo -u postgres psql
```

### PostgreSQL-is

```sql
\l              -- list databases
\du             -- list users
\c testapp_db   -- connect to database
\q              -- quit
```

### Ansible test

Lisa `tasks/main.yml` l√µppu, et kontrollida √ºhendust automaatselt:

```yaml
# tasks/main.yml
- name: Test database connection
  community.postgresql.postgresql_query:
    db: "{{ postgres_db_name }}"
    login_user: "{{ postgres_user }}"
    login_password: "{{ postgres_password }}"
    query: "SELECT version();"
  become: yes
  become_user: postgres
  register: db_version
  changed_when: false # See task ei muuda kunagi s√ºsteemi

- name: Show database version
  debug:
    var: db_version.query_result
```

-----

## 8\. Esitamine

**Struktuur peab olema:**

```
ansible-role-postgresql/
‚îú‚îÄ‚îÄ defaults/
‚îú‚îÄ‚îÄ handlers/
‚îú‚îÄ‚îÄ meta/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ tasks/
‚îú‚îÄ‚îÄ templates/
‚îî‚îÄ‚îÄ vars/
```

### README.md peab sisaldama:

  * Rolli kirjeldust
  * N√µudeid
  * Muutujaid (default & internal)
  * N√§idist playbook‚Äôi
  * Testimisjuhendit
  * Litsentsi ja autorit

-----

## Refleksioon

Lisa `README.md` l√µppu v√µi eraldi faili `REFLECTION.md`:

1.  Mis oli k√µige raskem ja kuidas lahendasid?
2.  Milline kontseptsioon oli suurim ‚Äúahaa\!‚Äù hetk?
3.  Kuidas kasutaksid PostgreSQL rolli tulevikus?
4.  Kuidas selgitaksid s√µbrale, mis on Ansible rollid?
5.  Mis oli sarnane ja mis erinev Nginx rolliga?

-----

## Hindamiskriteeriumid

| Kriteerium    | Punktid | Kirjeldus                      |
| ------------- | ------- | ------------------------------ |
| Struktuur      | 15      | Galaxy standard                |
| Tasks         | 20      | Paigaldamine, DB ja kasutaja loomine |
| Idempotentsus | 15      | `changed=0` teisel k√§ivitamisel    |
| Muutujad      | 10      | `defaults` vs `vars` √µigesti kasutatud |
| Template‚Äôid   | 15      | `postgresql.conf` + `pg_hba.conf` t√∂√∂tavad |
| Handlers      | 10      | Restart/reload korrektsed      |
| README        | 10      | T√§ielik dokumentatsioon        |
| Refleksioon   | 5       | K√µik 5 k√ºsimust vastatud       |
| **Kokku** | **100** |                                |

### Boonus (+10 punkti)

  * Multi-OS tugi
  * Backup cron job
  * Replication setup

-----

## Kasulikud Ressursid

  * [PostgreSQL Ansible Modules](https://docs.ansible.com/ansible/latest/collections/community/postgresql/)
  * [PostgreSQL Official Docs](https://www.postgresql.org/docs/14/)
  * [Ansible Best Practices](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)

\!\!\! tip

  - Kui `pg_hba.conf` muudatused ei m√µju ‚Üí tee **restart**, mitte reload.
  - Kui ‚Äúpermission denied‚Äù ‚Üí kontrolli, et kasutad `become_user: postgres`.
  - Kui template muutujad puuduvad ‚Üí lisa need `defaults/main.yml` faili.
  - Kui idempotentsus ei t√∂√∂ta ‚Üí v√§ldi `command` ja `shell` mooduleid; kasuta spetsiifilisi Ansible mooduleid.

-----

## Esitamine

**Kuhu:**
GitHub public repository (nt `https://github.com/SINU-USERNAME/ansible-role-postgresql`)
**Millal:**
1 n√§dal p√§rast laborit
**Formaat:**
Public repo URL + README v√µi REFLECTION.md
-----

**Edu\! üöÄ**
