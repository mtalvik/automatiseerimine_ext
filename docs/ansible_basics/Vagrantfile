# ðŸš€ Vagrant Seadistus Ansible Laboriks
# Loob 2 Ubuntu VM-i Ansible harjutamiseks

Vagrant.configure("2") do |config|
  
  # Common settings for both VMs
  config.vm.box = "ubuntu/jammy64"  # Ubuntu 22.04 LTS
  
  # VM1: Ansible Controller
  config.vm.define "controller" do |controller|
    controller.vm.hostname = "ansible-controller"
    controller.vm.network "private_network", ip: "192.168.56.10"
    
    controller.vm.provider "virtualbox" do |vb|
      vb.name = "ansible-controller"
      vb.memory = "1024"
      vb.cpus = 1
    end
    
    # Install Ansible on controller
    controller.vm.provision "shell", inline: <<-SHELL
      apt-get update
      apt-get install -y software-properties-common
      apt-get install -y ansible git vim
      
      # Create ansible user
      useradd -m -s /bin/bash ansible
      echo "ansible:ansible123" | chpasswd
      echo "ansible ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
      
      # Enable password authentication for SSH (for initial setup)
      sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
      systemctl restart sshd
      
      echo "Controller ready! IP: 192.168.56.10"
      echo "Login: vagrant (auto) or ansible/ansible123"
    SHELL
  end
  
  # VM2: Web Server (target)
  config.vm.define "webserver" do |webserver|
    webserver.vm.hostname = "web-server"
    webserver.vm.network "private_network", ip: "192.168.56.11"
    
    webserver.vm.provider "virtualbox" do |vb|
      vb.name = "ansible-webserver"
      vb.memory = "1024"
      vb.cpus = 1
    end
    
    webserver.vm.provision "shell", inline: <<-SHELL
      apt-get update
      
      # Create ansible user
      useradd -m -s /bin/bash ansible
      echo "ansible:ansible123" | chpasswd
      echo "ansible ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
      
      # Enable password authentication for SSH
      sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
      systemctl restart sshd
      
      echo "Web server ready! IP: 192.168.56.11"
      echo "Login: vagrant (auto) or ansible/ansible123"
    SHELL
  end
  
  # Shared folder for your Ansible files
  config.vm.synced_folder ".", "/vagrant", disabled: false
end
